<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>出行调度沙盘</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body { background-color: #f4f7f9; font-family: 'Inter', -apple-system, sans-serif; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .header-banner {
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            color: #ffffff; padding: 30px 0; border-radius: 0 0 24px 24px; margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        .indicator-box { font-size: 2.4rem; font-weight: 800; line-height: 1.2; }
        .status-card { transition: all 0.3s ease; border-left: 8px solid #6c757d; }
    </style>
</head>
<body>

<div class="header-banner text-center">
    <h2 class="fw-bold m-0" style="letter-spacing: 2px;">出行调度沙盘</h2>
</div>

<div class="container-fluid px-5">
    <div class="row">
        <div class="col-md-3">
            <div class="card p-4 mb-4">
                <h6 class="text-uppercase text-muted fw-bold mb-3">时空坐标</h6>
                <select id="dateSelect" class="form-select mb-3" onchange="updateTimes(); runSimulation();"></select>
                <select id="timeSelect" class="form-select mb-4" onchange="runSimulation();"></select>

                <h6 class="text-uppercase text-muted fw-bold mb-3">决策微调</h6>
                <input type="range" class="form-range" id="delaySlider" min="5" max="45" step="5" value="15"
                       oninput="document.getElementById('delayLabel').innerText=this.value+' 分钟'"
                       onchange="runSimulation()">
                <div class="text-center mt-2 text-primary fw-bold small">推迟时间: <span id="delayLabel">15 分钟</span></div>
            </div>

            <div class="card p-4 text-center">
                <h6 class="text-muted small fw-bold">当前车速 (T=0)</h6>
                <div class="indicator-box text-dark" id="currentSpeed">-- <span class="fs-6">km/h</span></div>
                <hr class="my-3">
                <h6 class="text-muted small fw-bold">当前密度 (T=0)</h6>
                <div class="indicator-box text-secondary" id="currentDensity">-- <span class="fs-6">veh/km</span></div>
            </div>
        </div>

        <div class="col-md-9">
            <div class="card p-4 mb-4 status-card" id="statusCard">
                <h5 class="fw-bold mb-1" id="statusText">正在同步数据...</h5>
                <p class="mb-0 opacity-75" id="adviceText">等待指令输入</p>
            </div>

            <div class="card p-4">
                <h6 class="text-muted fw-bold mb-4">断面流量预测 (Traffic Flow Projection)</h6>
                <div id="mainChart" style="width: 100%; height: 450px;"></div>
                <div class="mt-4 text-end">
                    <span class="text-muted small me-3">典型场景：</span>
                    <button class="btn btn-sm btn-outline-secondary px-3" onclick="jumpToCase('08:00')">早高峰</button>
                    <button class="btn btn-sm btn-outline-secondary px-3" onclick="jumpToCase('06:30')">平峰</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const dateTimeMap = {{ date_time_map | tojson }};
    const dateSelect = document.getElementById('dateSelect');
    const timeSelect = document.getElementById('timeSelect');
    let myChart = echarts.init(document.getElementById('mainChart'));

    function initSelectors() {
        for (let date in dateTimeMap) { dateSelect.add(new Option(date, date)); }
        updateTimes();
    }

    function updateTimes() {
        let selectedDate = dateSelect.value;
        timeSelect.innerHTML = '';
        dateTimeMap[selectedDate].forEach(t => timeSelect.add(new Option(t, t)));
    }

    function jumpToCase(timeStr) {
        timeSelect.value = timeStr;
        runSimulation();
    }

    async function runSimulation() {
        const res = await fetch('/api/predict', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ date: dateSelect.value, time: timeSelect.value, delay_minutes: document.getElementById('delaySlider').value })
        });
        const data = await res.json();
        if(data.error) return;

        // 更新状态卡片颜色
        const card = document.getElementById('statusCard');
        const sText = document.getElementById('statusText');
        const aText = document.getElementById('adviceText');
        sText.innerText = data.status;
        aText.innerText = data.advice;

        if (data.status === "运行顺畅") {
            card.style.backgroundColor = "#eafaf1"; card.style.borderLeftColor = "#2ecc71"; sText.style.color = "#145a32";
        } else if (data.status === "预期拥堵") {
            card.style.backgroundColor = "#fef9e7"; card.style.borderLeftColor = "#f1c40f"; sText.style.color = "#7d6608";
        } else {
            card.style.backgroundColor = "#fdedec"; card.style.borderLeftColor = "#e74c3c"; sText.style.color = "#7b241c";
        }

        document.getElementById('currentSpeed').innerHTML = `${data.current_status.speed} <span class="fs-6">km/h</span>`;
        document.getElementById('currentDensity').innerHTML = `${data.current_status.density} <span class="fs-6">veh/km</span>`;

        let historyData = data.history.times.map((t, i) => [t, data.history.flows[i]]);
        let currentPoint = historyData[historyData.length - 1];
        renderChart(historyData, [currentPoint, [data.now_pred.time, data.now_pred.flow]], [currentPoint, [data.delayed_pred.time, data.delayed_pred.flow]], currentPoint[0], data.warn_limit, data.capacity);
    }

    function renderChart(historyData, nowPredData, delayedPredData, currentTime, warnLimit, capacity) {
        myChart.setOption({
            tooltip: { trigger: 'axis' },
            legend: { top: 0, icon: 'rect' },
            xAxis: { type: 'category', boundaryGap: false },
            yAxis: { type: 'value', name: '流量 (veh/h)', min: 1000, max: 6500 },
            series: [
                {
                    name: '实测流量', type: 'line', data: historyData, smooth: true,
                    lineStyle: { width: 3, color: '#34495e' }, areaStyle: { color: 'rgba(52,73,94,0.1)' }, symbol: 'none'
                },
                {
                    name: '预测：立即出发', type: 'line', data: nowPredData,
                    lineStyle: { width: 2, type: 'dashed', color: '#e74c3c' }, itemStyle: { color: '#e74c3c' }
                },
                {
                    name: '预测：推迟错峰', type: 'line', data: delayedPredData,
                    lineStyle: { width: 2, type: 'dashed', color: '#27ae60' }, itemStyle: { color: '#27ae60' }
                }
            ],
            markLine: {
                symbol: ['none', 'none'],
                data: [
                    { yAxis: warnLimit, label: {formatter: '预警线'}, lineStyle: {color: '#f39c12', type: 'dotted'} },
                    { yAxis: capacity, label: {formatter: '物理容量'}, lineStyle: {color: '#c0392b'} },
                    { xAxis: currentTime, label: {formatter: '当前时刻'}, lineStyle: { color: '#8e44ad' } }
                ]
            }
        });
    }

    window.onload = () => { initSelectors(); runSimulation(); };
</script>
</body>
</html>